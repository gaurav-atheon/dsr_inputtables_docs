version: 2

sources:
    - name: dsr_input
      description: Standard input tables for all inbound DSR data.
      database: AA_DSR_RAW
      tables:
        - name: input_location
          description: Raw location data from origin organisations.
          tests:
            - dbt_utils.unique_combination_of_columns:
                combination_of_columns:
                  - business_organisation_number
                  - origin_organisation_number
                  - organisation_location_id
                  - location_function
                  - loaded_timestamp
          columns:
            - name: business_organisation_number
              description: Nummber assigned to the organisation by the origin.
              tests:
                - not_null
            - name: origin_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: organisation_location_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: location_function
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null

        - name: input_location_group
          description: Raw location data from origin organisations.
          tests:
            - dbt_utils.unique_combination_of_columns:
                combination_of_columns:
                  - creator_origin_organisation_number
                  - creator_business_organisation_number
                  - organisation_location_id
                  - subject_origin_organisation_number
                  - subject_business_organisation_number
                  - location_function
                  - group_name
                  - loaded_timestamp
          columns:
            - name: creator_origin_organisation_number
              description: Nummber assigned to the organisation by the origin.
              tests:
                - not_null
            - name: creator_business_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: organisation_location_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: subject_origin_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: subject_business_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: location_function
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: group_name
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
        - name: input_location_parentage
          description: Raw location data from origin organisations.
          tests:
            - dbt_utils.unique_combination_of_columns:
                combination_of_columns:
                  - subject_origin_organisation_number
                  - subject_business_organisation_number
                  - subject_organisation_location_id
                  - subject_location_function
                  - parent_origin_organisation_number
                  - parent_business_organisation_number
                  - parent_organisation_location_id
                  - parent_location_function
                  - creator_origin_organisation_number
                  - creator_business_organisation_number
                  - loaded_timestamp
          columns:
            - name: subject_origin_organisation_number
              description: Nummber assigned to the organisation by the origin.
              tests:
                - not_null
            - name: subject_business_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: subject_organisation_location_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: subject_location_function
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: parent_origin_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: parent_business_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: parent_organisation_location_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: parent_location_function
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: creator_origin_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
            - name: creator_business_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null
models:
  - name: stg_location
    columns:
      - name: location_id
        tests:
          - check_distinct_sku_fetched:
              env: ci
          - check_all_sku_fetched:
             columnlist:
              - origin_organisation_number
              - business_organisation_number
              - organisation_location_id
              - location_function
             env: ci
          - check_latest_sku_fetched:
              columnlist:
              - origin_organisation_number
              - business_organisation_number
              - organisation_location_id
              - location_function
              env: ci
  - name: stg_location_group
    columns:
        - name: location_mapping_id
          tests:
            - check_distinct_sku_fetched:
                env: ci
            - check_all_sku_fetched:
                columnlist:
                  - creator_origin_organisation_number
                  - creator_business_organisation_number
                  - group_name
                  - organisation_location_id
                  - subject_origin_organisation_number
                  - subject_business_organisation_number
                  - location_function
                env: ci
            - check_latest_sku_fetched:
                columnlist:
                  - creator_origin_organisation_number
                  - creator_business_organisation_number
                  - group_name
                  - organisation_location_id
                  - subject_origin_organisation_number
                  - subject_business_organisation_number
                  - location_function
                env: ci
  - name: stg_location_parentage
    columns:
        - name: parentage_id
          tests:
            - check_distinct_sku_fetched:
                env: ci
            - check_all_sku_fetched:
                columnlist:
                  - subject_origin_organisation_number
                  - subject_business_organisation_number
                  - subject_organisation_location_id
                  - subject_location_function
                  - creator_origin_organisation_number
                  - creator_business_organisation_number
                env: ci
            - check_latest_sku_fetched:
                columnlist:
                  - subject_origin_organisation_number
                  - subject_business_organisation_number
                  - subject_organisation_location_id
                  - subject_location_function
                  - creator_origin_organisation_number
                  - creator_business_organisation_number
                env: ci