version: 2

sources:
    - name: dsr_input
      description: Standard input tables for all inbound DSR data.
      database: AA_DSR_RAW
      tables:
        - name: input_pln_mvt_depotstoredaysku
          description: Raw product data from origin organisations.
          tests:
            - unique_combination_of_columns:
                combination_of_columns:
                  - base_forecast_date
                  - forecast_date
                  - source_db_id
                  - organisation_sku
                  - organisation_location_id_from
                  - organisation_location_id_to
                  - model_version
                  - forecast_components
                  - loaded_timestamp
                env: prod
          columns:
            - name: source_db_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: base_forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: organisation_sku
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: organisation_location_id_from
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: organisation_location_id_to
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: model_version
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod

        - name: input_pln_mvt_daysku
          description: Raw product data from origin organisations.
          tests:
            - unique_combination_of_columns:
                combination_of_columns:
                  - base_forecast_date
                  - forecast_date
                  - source_db_id
                  - subject_business_organisation_number
                  - organisation_sku
                  - model_version
                  - forecast_components
                  - loaded_timestamp
                env: prod
          columns:
            - name: source_db_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: base_forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: organisation_sku
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_business_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: forecast_components
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: model_version
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
        - name: input_pln_mvt_storedaysku
          description: Raw product data from origin organisations.
          tests:
            - unique_combination_of_columns:
                combination_of_columns:
                  - base_forecast_date
                  - forecast_date
                  - source_db_id
                  - subject_business_organisation_number
                  - subject_organisation_location_id_to
                  - organisation_sku
                  - model_version
                  - forecast_components
                  - loaded_timestamp
                env: prod
          columns:
            - name: source_db_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: base_forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: organisation_sku
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_business_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_organisation_location_id_to
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: model_version
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
        - name: input_pln_mvt_orgdepotdaysku
          description: Raw product data from origin organisations.
          tests:
            - unique_combination_of_columns:
                combination_of_columns:
                  - base_forecast_date
                  - forecast_date
                  - source_db_id
                  - subject_organisation_sku
                  - subject_origin_organisation_number
                  - subject_business_organisation_number_from
                  - subject_business_organisation_number_to
                  - subject_organisation_location_id_to
                  - model_version
                  - forecast_components
                  - loaded_timestamp
                env: prod
          columns:
            - name: source_db_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: base_forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_organisation_sku
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_origin_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_business_organisation_number_from
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_business_organisation_number_to
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_organisation_location_id_to
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: model_version
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod

        - name: input_pln_mvt_orgstoredaysku
          description: Raw product data from origin organisations.
          tests:
            - unique_combination_of_columns:
                combination_of_columns:
                  - base_forecast_date
                  - forecast_date
                  - source_db_id
                  - organisation_sku
                  - subject_origin_organisation_number
                  - subject_organisation_location_id_to
                  - model_version
                  - forecast_components
                  - loaded_timestamp
                env: prod
          columns:
            - name: source_db_id
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: base_forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: forecast_date
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: organisation_sku
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_business_organisation_number
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: subject_organisation_location_id_to
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod
            - name: model_version
              description: Number assigned to the organisation by the origin organisation.
              tests:
                - not_null:
                    env: prod


models:
  - name: stg_pln_mvt_daysku
    description: '{{ doc("stg_pln_mvt_daysku") }}'
    columns:
      - name: unique_key
        tests:
          - check_distinct_sku_fetched:
              env: ci
          - check_all_sku_fetched:
             columnlist:
              - base_forecast_date
              - forecast_date
              - source_db_id
              - subject_business_organisation_number
              - organisation_sku
              - model_version
             env: ci
          - check_latest_sku_fetched:
              columnlist:
              - base_forecast_date
              - forecast_date
              - source_db_id
              - subject_business_organisation_number
              - organisation_sku
              - model_version
              env: ci
      - name: source_db_id
        tests:
          - relationships:
              to: ref('utl_source_organisations')
              field: business_organisation_number
      - name: subject_business_organisation_number
        tests:
          - relationships:
              to: ref('dim_organisation_mapping')
              field: business_organisation_number
      - name: organisation_sku
        tests:
          - relationships:
              to: ref('dim_product')
              field: organisation_sku

  - name: stg_pln_mvt_depotstoredaysku
    description: '{{ doc("stg_pln_mvt_depotstoredaysku") }}'
    columns:
      - name: unique_key
        tests:
          - check_distinct_sku_fetched:
              env: ci
          - check_all_sku_fetched:
             columnlist:
              - base_forecast_date
              - forecast_date
              - source_db_id
              - organisation_location_id_from
              - organisation_location_id_to
              - organisation_sku
              - model_version
             env: ci
          - check_latest_sku_fetched:
              columnlist:
              - base_forecast_date
              - forecast_date
              - source_db_id
              - organisation_location_id_from
              - organisation_location_id_to
              - organisation_sku
              - model_version
              env: ci
      - name: source_db_id
        tests:
          - relationships:
              to: ref('utl_source_organisations')
              field: business_organisation_number
      - name: organisation_location_id_to
        tests:
          - relationships:
              to: ref('dim_location')
              field: organisation_location_id
      - name: organisation_location_id_from
        tests:
          - relationships:
              to: ref('dim_location')
              field: organisation_location_id
      - name: organisation_sku
        tests:
          - relationships:
              to: ref('dim_product')
              field: organisation_sku

  - name: stg_pln_mvt_orgdepotdaysku
    description: '{{ doc("stg_pln_mvt_orgdepotdaysku") }}'
    columns:
      - name: unique_key
        tests:
          - check_distinct_sku_fetched:
              env: ci
          - check_all_sku_fetched:
             columnlist:
              - base_forecast_date
              - forecast_date
              - source_db_id
              - subject_origin_organisation_number
              - subject_organisation_location_id_to
              - subject_business_organisation_number_from
              - subject_business_organisation_number_to
              - subject_organisation_sku
              - model_version
             env: ci
          - check_latest_sku_fetched:
              columnlist:
              - base_forecast_date
              - forecast_date
              - source_db_id
              - subject_origin_organisation_number
              - subject_organisation_location_id_to
              - subject_business_organisation_number_from
              - subject_business_organisation_number_to
              - subject_organisation_sku
              - model_version
              env: ci
      - name: source_db_id
        tests:
          - relationships:
              to: ref('utl_source_organisations')
              field: business_organisation_number
      - name: subject_business_organisation_number_to
        tests:
          - relationships:
              to: ref('dim_organisation_mapping')
              field: business_organisation_number
      - name: subject_business_organisation_number_from
        tests:
          - relationships:
              to: ref('dim_organisation_mapping')
              field: business_organisation_number
      - name: subject_organisation_location_id_to
        tests:
          - relationships:
              to: ref('dim_location')
              field: organisation_location_id
      - name: subject_organisation_sku
        tests:
          - relationships:
              to: ref('dim_product')
              field: organisation_sku
  - name: stg_pln_mvt_storedaysku
    description: '{{ doc("stg_pln_mvt_storedaysku") }}'
    columns:
        - name: unique_key
          tests:
            - check_distinct_sku_fetched:
                env: ci
            - check_all_sku_fetched:
                columnlist:
                  - base_forecast_date
                  - forecast_date
                  - source_db_id
                  - subject_business_organisation_number
                  - subject_organisation_location_id_to
                  - organisation_sku
                  - model_version
                env: ci
            - check_latest_sku_fetched:
                columnlist:
                  - base_forecast_date
                  - forecast_date
                  - source_db_id
                  - subject_business_organisation_number
                  - subject_organisation_location_id_to
                  - organisation_sku
                  - model_version
                env: ci
        - name: source_db_id
          tests:
            - relationships:
                to: ref('utl_source_organisations')
                field: business_organisation_number
        - name: subject_business_organisation_number
          tests:
            - relationships:
                to: ref('dim_organisation_mapping')
                field: business_organisation_number
        - name: organisation_sku
          tests:
            - relationships:
                to: ref('dim_product')
                field: organisation_sku
        - name: subject_organisation_location_id_to
          tests:
            - relationships:
                to: ref('dim_location')
                field: organisation_location_id
  - name: stg_pln_mvt_orgstoredaysku
    columns:
      - name: unique_key
        tests:
          - check_distinct_sku_fetched:
              env: ci
          - check_all_sku_fetched:
              columnlist:
                - base_forecast_date
                - forecast_date
                - source_db_id
                - subject_business_organisation_number
                - subject_organisation_location_id_to
                - organisation_sku
                - model_version
              env: ci
          - check_latest_sku_fetched:
              columnlist:
                - base_forecast_date
                - forecast_date
                - source_db_id
                - subject_business_organisation_number
                - subject_organisation_location_id_to
                - organisation_sku
                - model_version
              env: ci
      - name: source_db_id
        tests:
          - relationships:
              to: ref('utl_source_organisations')
              field: business_organisation_number
      - name: subject_business_organisation_number
        tests:
          - relationships:
              to: ref('dim_organisation_mapping')
              field: business_organisation_number
      - name: organisation_sku
        tests:
          - relationships:
              to: ref('dim_product')
              field: organisation_sku
      - name: subject_organisation_location_id_to
        tests:
          - relationships:
              to: ref('dim_location')
              field: organisation_location_id